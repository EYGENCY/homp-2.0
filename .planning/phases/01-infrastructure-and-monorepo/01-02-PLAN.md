---
phase: 01-infrastructure-and-monorepo
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - turbo.json
  - pnpm-workspace.yaml
  - package.json
  - packages/db/drizzle.config.ts
  - packages/db/package.json
  - packages/db/src/index.ts
  - packages/db/migrations/0000_baseline.sql
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03

must_haves:
  truths:
    - "`docker compose up` starts postgres, redis, and minio; postgres and redis pass health checks before dependent services start"
    - "`pnpm dev` from monorepo root starts both Next.js (port 3000) and Hono API (port 3001) concurrently via Turbo"
    - "`pnpm --filter @homp/db migrate` applies the baseline migration without error on a fresh database"
    - "`pnpm db:reset` from monorepo root drops and recreates the local database and re-runs migrations"
  artifacts:
    - path: "docker-compose.yml"
      provides: "PostgreSQL 16, Redis 7, MinIO with health checks"
      contains: "healthcheck"
    - path: "turbo.json"
      provides: "Turbo pipeline with globalPassThroughEnv for all env vars"
      contains: "globalPassThroughEnv"
    - path: "packages/db/drizzle.config.ts"
      provides: "Drizzle Kit config using defineConfig, dialect: postgresql, url key"
      contains: "defineConfig"
    - path: "packages/db/migrations/0000_baseline.sql"
      provides: "Baseline migration enabling uuid-ossp extension"
      contains: "uuid-ossp"
  key_links:
    - from: "docker-compose.yml postgres service"
      to: "docker-compose.yml redis service"
      via: "No direct depends_on needed — services are independent; health checks make them self-healing"
      pattern: "healthcheck"
    - from: "turbo.json globalPassThroughEnv"
      to: "apps/* env vars"
      via: "Turbo passes declared vars to all tasks without affecting cache hash"
      pattern: "globalPassThroughEnv"
    - from: "packages/db/drizzle.config.ts"
      to: "packages/db/migrations/"
      via: "drizzle-kit migrate reads config to locate migration files"
      pattern: "out:.*migrations"
---

<objective>
Complete the local development stack: add health checks to docker-compose services, wire Turbo env passthrough, upgrade Drizzle packages from 0.20.x to 0.31.x, fix the deprecated drizzle.config.ts format, create the baseline migration, and add convenience scripts.

Purpose: Makes `docker compose up` reliable (no race conditions), `pnpm dev` functional from monorepo root, and `drizzle-kit migrate` safe to run. These are the foundational mechanics that everything else in the phase depends on.

Output: Working `docker compose up`, `pnpm dev`, and `pnpm --filter @homp/db migrate` commands.
</objective>

<execution_context>
@/Users/sr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-and-monorepo/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add docker-compose health checks and update turbo.json env passthrough</name>
  <files>
    docker-compose.yml
    turbo.json
  </files>
  <action>
**docker-compose.yml** — Replace the existing file with health checks on postgres and redis. MinIO uses a curl-based health check (the `mc ready local` command is NOT reliably available in the MinIO base image — use curl instead):

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: homp
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d homp"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/minio/health/live || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

volumes:
  postgres_data:
  redis_data:
  minio_data:
```

**turbo.json** — Replace the existing file to add `globalPassThroughEnv` for all project env vars. The `globalPassThroughEnv` key makes vars available to all tasks without affecting the Turbo cache hash (correct for secrets). The `build` task's `env` array lists vars that CAN affect build output (affects cache keying — not secrets, just configuration):

```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalPassThroughEnv": [
    "DATABASE_URL",
    "REDIS_URL",
    "S3_ENDPOINT",
    "S3_BUCKET",
    "S3_ACCESS_KEY_ID",
    "S3_SECRET_ACCESS_KEY",
    "S3_REGION",
    "NEXT_PUBLIC_API_URL",
    "NODE_ENV",
    "PORT"
  ],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"],
      "env": [
        "DATABASE_URL",
        "NEXT_PUBLIC_API_URL",
        "NODE_ENV"
      ]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {}
  }
}
```
  </action>
  <verify>
```bash
# Verify health check syntax is valid by parsing the file
docker compose -f /Users/sr/homp-2.0/docker-compose.yml config --quiet
# Should exit 0 with no errors

# Verify turbo.json is valid JSON
node -e "JSON.parse(require('fs').readFileSync('/Users/sr/homp-2.0/turbo.json', 'utf8')); console.log('valid')"
```
  </verify>
  <done>
`docker compose config --quiet` exits 0. `docker-compose.yml` contains `healthcheck` entries for postgres, redis, and minio. `turbo.json` contains `globalPassThroughEnv` array with all 10 env vars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade Drizzle, fix drizzle.config.ts, create baseline migration, add db:reset script</name>
  <files>
    packages/db/drizzle.config.ts
    packages/db/package.json
    packages/db/src/index.ts
    packages/db/migrations/0000_baseline.sql
    package.json
  </files>
  <action>
**Step 1 — Upgrade drizzle packages in packages/db:**

```bash
cd /Users/sr/homp-2.0
pnpm --filter @homp/db add drizzle-orm@^0.45.1
pnpm --filter @homp/db add -D drizzle-kit@^0.31.9
```

Also remove the `pg` package (not needed; the codebase uses `postgres.js` via the `postgres` package, not `pg`):
```bash
pnpm --filter @homp/db remove pg @types/pg
```

**Step 2 — Fix packages/db/drizzle.config.ts** (current file uses deprecated `driver: "pg"` and `dbCredentials.connectionString` from drizzle-kit 0.20.x):

Replace with the drizzle-kit 0.31.x format:
```typescript
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  out: "./migrations",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

Key changes:
- `defineConfig()` wrapper (replaces `satisfies Config`)
- `dialect: "postgresql"` (replaces `driver: "pg"`)
- `dbCredentials.url` (replaces `dbCredentials.connectionString`)

**Step 3 — Update packages/db/src/index.ts** to use the correct postgres.js client export name (current code exports `client` which is the raw postgres.js tagged-template client — this is what the Hono API uses for `await client\`SELECT 1\``):

Verify the current content is correct for postgres.js usage. The current export `client` using `postgres(connectionString)` is correct for Drizzle + postgres.js. No changes needed unless schema import path needs fixing.

Check `packages/db/src/schema.ts` exists. If empty, add a minimal comment:
```typescript
// Phase 1: schema is empty — application tables added in Phase 2
// Drizzle requires this file to exist for drizzle-kit to work
```

**Step 4 — Create packages/db/migrations/0000_baseline.sql** (do NOT use `drizzle-kit generate` — it would produce an empty file since schema.ts is empty; create the file manually):

```sql
-- 0000_baseline.sql
-- Baseline migration for HOMP 2.0 — Phase 1
-- Enables uuid-ossp extension for uuid_generate_v4() in future tables
-- The IF NOT EXISTS guard makes this safe to run on any database state
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

**Step 5 — Add db:reset and db:migrate scripts:**

Update `packages/db/package.json` scripts section to add `db:reset`:
```json
{
  "scripts": {
    "generate": "drizzle-kit generate",
    "migrate": "drizzle-kit migrate",
    "push": "drizzle-kit push",
    "studio": "drizzle-kit studio",
    "db:reset": "docker compose -f ../../docker-compose.yml down -v postgres && docker compose -f ../../docker-compose.yml up -d postgres && sleep 3 && drizzle-kit migrate"
  }
}
```

Update root `package.json` to add monorepo-level convenience scripts:
```json
{
  "scripts": {
    "build": "turbo run build",
    "dev": "turbo run dev",
    "lint": "turbo run lint",
    "format": "prettier --write \"**/*.{ts,tsx,md}\"",
    "db:migrate": "pnpm --filter @homp/db migrate",
    "db:reset": "pnpm --filter @homp/db db:reset"
  }
}
```

Also update `apps/api/package.json` dev script to load the root `.env` file via `--env-file` (Next.js loads its own .env from its directory; Hono/tsx needs explicit loading):
```json
{
  "scripts": {
    "dev": "tsx --env-file=../../.env watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  }
}
```

For apps/web, create a symlink so Next.js finds the root `.env`:
```bash
ln -sf ../../.env /Users/sr/homp-2.0/apps/web/.env
```
And add `apps/web/.env` to `.gitignore` (already covered by the pattern in Plan 01's `.gitignore`).
  </action>
  <verify>
```bash
cd /Users/sr/homp-2.0
# Verify drizzle packages upgraded
pnpm --filter @homp/db exec node -e "const d = require('./node_modules/drizzle-kit/package.json'); console.log('drizzle-kit:', d.version)"
# Should show 0.31.x

# Verify migration file exists
ls /Users/sr/homp-2.0/packages/db/migrations/0000_baseline.sql

# Verify drizzle config is valid (dry-run — won't actually migrate)
cd /Users/sr/homp-2.0 && pnpm --filter @homp/db exec drizzle-kit --version
# Should show 0.31.x
```
  </verify>
  <done>
`packages/db/drizzle.config.ts` uses `defineConfig`, `dialect: "postgresql"`, and `dbCredentials.url`. `packages/db/migrations/0000_baseline.sql` exists with `CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`. drizzle-kit is at version 0.31.x. Root `package.json` has `db:migrate` and `db:reset` convenience scripts.
  </done>
</task>

</tasks>

<verification>
1. `docker compose -f /Users/sr/homp-2.0/docker-compose.yml config --quiet` exits 0
2. `docker-compose.yml` has `healthcheck` blocks for all three services (postgres, redis, minio)
3. `turbo.json` has `globalPassThroughEnv` with DATABASE_URL, REDIS_URL, S3_*, NEXT_PUBLIC_API_URL, NODE_ENV, PORT
4. `packages/db/drizzle.config.ts` contains `defineConfig` and `dialect: "postgresql"`
5. `packages/db/migrations/0000_baseline.sql` contains `CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`
6. `apps/api/package.json` dev script uses `tsx --env-file=../../.env watch src/index.ts`
</verification>

<success_criteria>
- `docker compose up` completes with postgres and redis healthy (no "connection refused" errors)
- `turbo.json` passes all env vars to tasks without polluting the build cache hash
- `drizzle-kit migrate` (run from packages/db with DATABASE_URL set) applies the baseline migration cleanly
- `pnpm db:migrate` works from monorepo root
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-and-monorepo/01-02-SUMMARY.md`
</output>
