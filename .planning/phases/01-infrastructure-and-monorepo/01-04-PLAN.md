---
phase: 01-infrastructure-and-monorepo
plan: 04
type: execute
wave: 3
depends_on:
  - 01-02
  - 01-03
files_modified:
  - apps/api/railway.toml
  - apps/web/railway.toml
autonomous: true
requirements:
  - INFRA-04

must_haves:
  truths:
    - "Railway has a project with 4 services: homp-web (Next.js), homp-api (Hono), PostgreSQL, Redis"
    - "homp-api service uses `apps/api/railway.toml` with Railpack builder and `pnpm --filter api build` as the build command"
    - "homp-web service uses `apps/web/railway.toml` with Railpack builder and `pnpm --filter web build` as the build command"
    - "homp-api runs drizzle-kit migrate as preDeployCommand before each deploy"
    - "Both services use Railway variable references (`${{...}}`) to wire DATABASE_URL and REDIS_URL — no hardcoded credentials"
    - "Push to main branch triggers automatic redeployment of both services"
  artifacts:
    - path: "apps/api/railway.toml"
      provides: "Railway config for Hono API service"
      contains: "RAILPACK"
    - path: "apps/web/railway.toml"
      provides: "Railway config for Next.js web service"
      contains: "RAILPACK"
  key_links:
    - from: "apps/api/railway.toml preDeployCommand"
      to: "packages/db/migrations/"
      via: "drizzle-kit migrate runs before each API deploy ensuring schema is current"
      pattern: "preDeployCommand"
    - from: "Railway homp-api service DATABASE_URL"
      to: "Railway PostgreSQL plugin"
      via: "Variable reference ${{Postgres.DATABASE_URL}} auto-wired by Railway"
      pattern: "\\$\\{\\{Postgres"
---

<objective>
Create Railway deployment configuration files (`railway.toml`) for both app services and document the Railway project setup steps.

Purpose: Phase 1 ends with a live Railway URL. The `railway.toml` files are the source of truth for how each service builds and deploys — they go into git and Railway reads them automatically. Database migrations run automatically before each API deploy via `preDeployCommand`.

Output: `apps/api/railway.toml` and `apps/web/railway.toml`; Railway project running with all 4 services live.
</objective>

<execution_context>
@/Users/sr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-and-monorepo/01-RESEARCH.md
@.planning/phases/01-infrastructure-and-monorepo/01-01-SUMMARY.md
@.planning/phases/01-infrastructure-and-monorepo/01-02-SUMMARY.md
@.planning/phases/01-infrastructure-and-monorepo/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create railway.toml files for API and web services</name>
  <files>
    apps/api/railway.toml
    apps/web/railway.toml
  </files>
  <action>
**apps/api/railway.toml** — Hono API service configuration:

```toml
[build]
builder = "RAILPACK"
# Build from repo root (shared monorepo — packages/config and packages/db must be resolvable)
# Railpack auto-detects pnpm workspaces via pnpm-workspace.yaml and installs all dependencies
buildCommand = "pnpm --filter api build"

[deploy]
# Run migrations BEFORE starting the new deployment to ensure schema is current
# preDeployCommand runs in the deploy phase where env vars are available (not build phase)
preDeployCommand = "pnpm --filter @homp/db migrate"
startCommand = "node apps/api/dist/index.js"
# /health endpoint verifies DB and Redis are reachable — Railway waits for 200 before routing traffic
healthcheckPath = "/health"
healthcheckTimeout = 60
restartPolicyType = "ALWAYS"
```

**apps/web/railway.toml** — Next.js web service configuration:

```toml
[build]
builder = "RAILPACK"
# Build from repo root (shared monorepo — @homp/config must be resolvable)
buildCommand = "pnpm --filter web build"

[deploy]
startCommand = "pnpm --filter web start"
# Railway uses the root path to check if the web app is serving
healthcheckPath = "/"
healthcheckTimeout = 60
restartPolicyType = "ALWAYS"
```

**Critical Railway project setup (document for user — Railway CLI cannot fully automate service creation from scratch):**

The `railway.toml` files are created by this task. The Railway project itself requires these one-time setup steps via the Railway dashboard or CLI (documented for the verification checkpoint in Plan 05):

1. Create a new Railway project named "homp-2.0"
2. Add a PostgreSQL database plugin → Railway names it "Postgres" → provides `${{Postgres.DATABASE_URL}}`
3. Add a Redis plugin → Railway names it "Redis" → provides `${{Redis.REDIS_URL}}`
4. Create service "homp-api":
   - Source: GitHub repo (this repository), branch: main
   - Leave Root Directory EMPTY (repo root — critical for shared monorepo)
   - Railway will auto-detect `apps/api/railway.toml`
   - Set environment variables:
     - `DATABASE_URL` = `${{Postgres.DATABASE_URL}}`
     - `REDIS_URL` = `${{Redis.REDIS_URL}}`
     - `NODE_ENV` = `production`
     - `PORT` = `3001`
     - `S3_ENDPOINT` = (Railway Bucket endpoint or placeholder)
     - `S3_BUCKET` = `homp-prod`
     - `S3_ACCESS_KEY_ID` = (Railway Bucket key or placeholder)
     - `S3_SECRET_ACCESS_KEY` = (Railway Bucket secret or placeholder)
     - `S3_REGION` = `us-east-1`
   - Watch paths: `apps/api/**`, `packages/config/**`, `packages/db/**`
5. Create service "homp-web":
   - Source: GitHub repo, branch: main
   - Leave Root Directory EMPTY
   - Railway will auto-detect `apps/web/railway.toml`
   - Set environment variables:
     - `NEXT_PUBLIC_API_URL` = `https://<homp-api-domain>.up.railway.app`
     - `DATABASE_URL` = `${{Postgres.DATABASE_URL}}` (needed for build-time env validation)
     - `REDIS_URL` = `${{Redis.REDIS_URL}}`
     - `NODE_ENV` = `production`
     - `S3_ENDPOINT` = (Railway Bucket endpoint or placeholder)
     - `S3_BUCKET` = `homp-prod`
     - `S3_ACCESS_KEY_ID` = (Railway Bucket key or placeholder)
     - `S3_SECRET_ACCESS_KEY` = (Railway Bucket secret or placeholder)
     - `S3_REGION` = `us-east-1`
   - Watch paths: `apps/web/**`, `packages/config/**`

Note: `NEXT_PUBLIC_API_URL` for homp-web must be set AFTER the homp-api service gets its Railway domain. Use Railway's variable reference `${{homp-api.RAILWAY_PUBLIC_DOMAIN}}` if available, or set manually after first deploy.

Note on S3: For Phase 1, create a Railway Storage Bucket in the same project. Railway will auto-provision S3-compatible env vars. If the bucket is not ready yet, use placeholder values — the API startup will fail on S3 vars only if they are empty. Add `.default("")` to S3 vars in the schema if you need a graceful no-op until the bucket is set up. (Do not change the serverEnv schema — use Railway's env vars instead.)
  </action>
  <verify>
```bash
# Verify railway.toml files were created
cat /Users/sr/homp-2.0/apps/api/railway.toml
cat /Users/sr/homp-2.0/apps/web/railway.toml

# Verify they contain required fields
grep "RAILPACK" /Users/sr/homp-2.0/apps/api/railway.toml
grep "preDeployCommand" /Users/sr/homp-2.0/apps/api/railway.toml
grep "healthcheckPath" /Users/sr/homp-2.0/apps/api/railway.toml
grep "RAILPACK" /Users/sr/homp-2.0/apps/web/railway.toml
```
  </verify>
  <done>
`apps/api/railway.toml` and `apps/web/railway.toml` both exist with `builder = "RAILPACK"`, correct `buildCommand`, `startCommand`, and `healthcheckPath`. API config has `preDeployCommand` for migrations.
  </done>
</task>

</tasks>

<verification>
1. `apps/api/railway.toml` contains `builder = "RAILPACK"`, `buildCommand = "pnpm --filter api build"`, `preDeployCommand`, `healthcheckPath = "/health"`
2. `apps/web/railway.toml` contains `builder = "RAILPACK"`, `buildCommand = "pnpm --filter web build"`, `healthcheckPath = "/"`
3. Neither `railway.toml` sets a `rootDirectory` (correct — shared monorepo builds from repo root)
</verification>

<success_criteria>
- Both `railway.toml` files exist and contain correct Railpack configuration
- All git changes committed and ready to push to main for Railway auto-deploy trigger
- Railway project setup instructions are documented for the next checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-and-monorepo/01-04-SUMMARY.md`
</output>
